# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

parameters:
- name: tmpDirVar
  type: string
  default: tmpDir
- name: hostArch
  type: string
  default: amd64
- name: targetPlatform
  type: string
- name: vsDevCmdArch
  type: string
# numShards and the shards object must be kept in sync
- name: numShards
  type: number
  default: 8
- name: shards
  type: object
  default:
  - 1
  - 2
  - 3
  - 4
  - 5
  - 6
  - 7
  - 8
jobs:
- ${{ each shard in parameters.shards }}:
  - job: '$build_{{ parameters.targetPlatform }}_${{ shard }}'
    timeoutInMinutes: 360
  steps:
    - script: |
        if exist "$(${{ parameters.tmpDirVar }})" (rmdir /S /Q $(${{ parameters.tmpDirVar }}))
        mkdir $(${{ parameters.tmpDirVar }})
      displayName: 'Setup TMP Directory'

    - checkout: self
      clean: true
      submodules: false

    - template: azure-devops/checkout-sources.yml
    - template: azure-devops/vcpkg-dependencies.yml
      parameters:
        targetPlatform: ${{ parameters.targetPlatform }}
    - template: azure-devops/cmake-configure-build.yml
      parameters:
        targetPlatform: ${{ parameters.targetPlatform }}
        hostArch: amd64
        targetArch: ${{ parameters.vsDevCmdArch }}
        shardNum: ${{ shard }}
        numShards: ${{ parameters.numShards }}
        additionalLitFlags: ';-DTEST_BUILD_ONLY=TRUE'
    - template: azure-devops/run-tests.yml
      parameters:
        targetArch: ${{ parameters.vsDevCmdArch }}
        hostArch: ${{ parameters.hostArch }}
        shardNum: ${{ shard }}
        displayName: 'Build Tests'
